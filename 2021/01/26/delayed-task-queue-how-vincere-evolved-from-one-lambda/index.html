<!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--><!DOCTYPE html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Notes about startups, AI, health-care and overall engineering"><meta name=author content="Hadi Javeed"><link href=https://hadijaveed.me/2021/01/26/delayed-task-queue-how-vincere-evolved-from-one-lambda/ rel=canonical><link href=../../../../2017/07/29/making-responsive-grid-with-flexbox-and-lessjs/ rel=prev><link href=../../../../2022/03/04/helping-people-quit-smoking-through-financial-rewards/ rel=next><link rel=alternate type=application/rss+xml title="RSS feed" href=../../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="RSS feed of updated content" href=../../../../feed_rss_updated.xml><link rel=icon href=../../../../assets/logo.jpeg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.21"><title>Delayed task queue: How Vincere evolved from one Lambda to a persistent queue - Hadi Javeed's blog</title><link rel=stylesheet href=../../../../assets/stylesheets/main.2a3383ac.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../stylesheets/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XS27CVTCE3"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XS27CVTCE3",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XS27CVTCE3",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><meta property=og:type content=website><meta property=og:title content="Delayed task queue: How Vincere evolved from one Lambda to a persistent queue - Hadi Javeed's blog"><meta property=og:description content="Notes about startups, AI, health-care and overall engineering"><meta property=og:image content=https://hadijaveed.me/assets/images/social/posts/delayed-task-queue-vincere.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://hadijaveed.me/2021/01/26/delayed-task-queue-how-vincere-evolved-from-one-lambda/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Delayed task queue: How Vincere evolved from one Lambda to a persistent queue - Hadi Javeed's blog"><meta name=twitter:description content="Notes about startups, AI, health-care and overall engineering"><meta name=twitter:image content=https://hadijaveed.me/assets/images/social/posts/delayed-task-queue-vincere.png><link href=../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><script src=../../../../assets/javascripts/glightbox.min.js></script><style id=glightbox-style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#delayed-task-queue-how-vincere-evolved-from-one-lambda-to-a-persistent-queue class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title="Hadi Javeed's blog" class="md-header__button md-logo" aria-label="Hadi Javeed's blog" data-md-component=logo> <img src=../../../../assets/logo.jpeg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Hadi Javeed's blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Delayed task queue: How Vincere evolved from one Lambda to a persistent queue </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../../about/ class=md-tabs__link> About me </a> </li> <li class=md-tabs__item> <a href=https://newsletter.hadijaveed.me class=md-tabs__link> Subscribe </a> </li> <li class=md-tabs__item> <a href=../../../../archive/2025/ class=md-tabs__link> Archive </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Hadi Javeed's blog" class="md-nav__button md-logo" aria-label="Hadi Javeed's blog" data-md-component=logo> <img src=../../../../assets/logo.jpeg alt=logo> </a> Hadi Javeed's blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <a href=../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../about/ class=md-nav__link> <span class=md-ellipsis> About me </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=https://newsletter.hadijaveed.me class=md-nav__link> <span class=md-ellipsis> Subscribe </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <!-- Page content --> <article class="md-content__inner md-typeset"> <header class=md-post__header> <!-- Post authors --> <!-- Post metadata --> <div class="md-post__meta md-meta"> <div class=md-meta__list> <div style="margin-right: 1rem;"> <span class=md-author> <a href=https://www.linkedin.com/in/hadijaveed/ > <img src="https://avatars.githubusercontent.com/u/10227760?v=5" alt="Hadi Javeed"> </a> </span> </div> <!-- Post date --> <div class="md-meta__item blog-meta-header"> <time datetime="2021-01-26 00:00:00+00:00">2021/01/26</time></div> <!-- Post categories --> <!-- Post readtime --> <div class="md-meta__item blog-meta-header"> 10 min read </div> </div> <!-- Draft marker --> </div> </header> <h1 id=delayed-task-queue-how-vincere-evolved-from-one-lambda-to-a-persistent-queue>Delayed task queue: How Vincere evolved from one Lambda to a persistent queue<a class=headerlink href=#delayed-task-queue-how-vincere-evolved-from-one-lambda-to-a-persistent-queue title="Permanent link">¶</a></h1> <p>Vincere uses incentives. behavioral nudges and evidence-based interventions for healthy behaviors and making healthy choices. This requires us to track multiple events for users and nudging them through reminders/notifications towards better health</p> <!-- more --> <h2 id=our-background-and-requirements>Our Background and Requirements<a class=headerlink href=#our-background-and-requirements title="Permanent link">¶</a></h2> <p>Vincere allows health coaches to create a participant monitoring Campaign. A health coach can define the following things in a Campaign</p> <ul> <li> <p>Bio-marker feedback. e.g, CO(Carbon Monoxide) monitoring for smokers through a breathalyzer device using a mobile app. We are capable of doing other bio-marker feedback as well</p> </li> <li> <p>Define a Campaign to run for multiple days/months that can track multiple events just like on a calendar, e.g, breath test at a specific time or on a specific day, other bio-marker feedback, payment event where participants will be getting paid at a certain time or day, or participant/coach appointments for video/audio calls</p> </li> <li> <p>Define certain incentives/rewards criteria for achieving a certain goal in the defined testing window or making it to the appointments</p> </li> <li> <p>Define notifications criteria or reminders. These notifications are very personalized notifications and could be configured to go out at different intervals looking at the user information</p> </li> </ul> <hr style="border:1px solid #474545"> <p>Since we have to track different time-based testing windows and sending notifications at certain defined times we could not do this in a synchronous web request. We had some design discussions internally within the team about doing all of this on the client-side (front-end). We soon realized it will be hard to schedule something on the client-side if the app is not running in the background and another problem was besides doing push notifications we also deal with email/SMS notifications both for app participants and the health coaches, and events like payment processing where users will be getting paid. We decided to write a cronjob.</p> <p>Like many initial designs, our goal was to get something out there fast and working, to gather feedback from our users, and optimize later</p> <h2 id=first-iteration-of-background-jobs>First Iteration of Background Jobs<a class=headerlink href=#first-iteration-of-background-jobs title="Permanent link">¶</a></h2> <p>The first iteration worked like this</p> <ol> <li> <p>We had one Lambda function. that was triggered every 1 minute through a scheduled cloud-watch event</p> </li> <li> <p>It will scan all the rows in the Postgres Database and based on UTC timestamp it will decide to take action and perform different kinds of mutations in the database</p> </li> </ol> <p><a class=glightbox data-type=image data-width=auto data-height=auto href=https://miro.medium.com/v2/resize:fit:1042/format:webp/1*gCg-uQ9US1bscv_joJbtoA.png data-desc-position=bottom><img src=https://miro.medium.com/v2/resize:fit:1042/format:webp/1*gCg-uQ9US1bscv_joJbtoA.png title alt data-align=center></a></p> <h3 id=pros>Pros<a class=headerlink href=#pros title="Permanent link">¶</a></h3> <ul> <li>It was really easy to develop a Lambda function, where cron scheduling is handled by CloudWatch triggered events, which makes sure there is one execution of lambda function to avoid duplicate processing and we got something functional out there faster</li> </ul> <h3 id=cons>Cons<a class=headerlink href=#cons title="Permanent link">¶</a></h3> <ul> <li>It was a single point of failure and not fault-tolerant. And it did fail multiple times in later stages when there was an error related to a single event processing e.g, missing or malformed data and it had a cascading effect on the processing of all the events in that scheduled window. We re-factored the code but catching these errors in a fault-tolerant manner was hard. Also making sure one error does not cause all events to fail was hard</li> <li>One Lambda cannot scale horizontally. As we were not doing any workload distribution or a fan-out. As the events were growing it used to take one Lambda function much longer to process them all and most of the notifications were delayed. We vertically scaled the Lambda by increasing the memory/CPU and time limit within the AWS console. This gave us some runway to optimize later</li> </ul> <h2 id=second-iteration-of-background-jobs>Second Iteration of Background Jobs<a class=headerlink href=#second-iteration-of-background-jobs title="Permanent link">¶</a></h2> <p>We decided to use a background job queue to process different events and handle the scheduling piece of them using a delayed task queue. We had the following requirements from a job queue</p> <ul> <li>Tracking job state and stats e.g, the status of the job, the run duration, etc.</li> <li>Automatic recovery if a worker crashes e.g retries with exponential backoffs and tracking them</li> <li>Pushed based PUB/SUB design instead of continuous polling</li> <li>Scheduled and delayed jobs</li> <li>Low over-head over creating queue topics or multiple types of queues</li> <li>Concurrency and horizontally scaling the load among distributed workers across different CPUs</li> </ul> <p>Our stack was running on AWS. So we decided to explore <a href=https://aws.amazon.com/sqs/ target=_blank>SQS</a> as a distributed job queue for the fan-out and reliability. But we soon realized long scheduling jobs in the future are hard to achieve with SQS with an upper limit of 12 hours <a href=https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html target=_blank>visibility timeout</a> (time after which message is visible for processing). For long-scheduled tasks, a message needs to be picked up and delayed again depending on how long in the future a job is scheduled. This makes the design very complex when you have a job that has to run in the future e.g, an incentive payment event that has to run after a month</p> <p>Our team was already using Redis for caching purposes. We decided to use Redis as a delayed task execution queue. Redis supports delayed tasks with reasonable timing precision with minimal resource waste when idle. We explored a couple of stable packages for this use-case. e.g, <a href=https://github.com/sidekiq/sidekiq target=_blank>Sidekiq</a> in Rails, Celery with Redis in Python, and <a href=https://github.com/OptimalBits/bull target=_blank>Bull</a> in NodeJs. As most of our tech stack was in NodeJs we decided to go with the bull for running long-scheduled tasks and it fulfilled most of our requirements at the time</p> <p>The second iteration worked like this</p> <ol> <li>At the time of Campaign creation, we submit all the scheduled events to Redis through bull package with a timestamp it is supposed to run on, with high-level metadata about Campaign starting and ending date in the database</li> <li>A NodeJs process will process a job at some point in time when it is ready. We can add re-try logic in-case of failures and this was all handled by bull queue manager</li> <li>There could be multiple job processors running in multiple Node Docker containers for horizontal scalability. Bull aims for “at least once strategy”. But in some scenarios, a job could be retired multiple times. Making processes atomic is your job. We achieved this through PostgreSQL, which is discussed later in the article</li> </ol> <p><a class=glightbox data-type=image data-width=auto data-height=auto href=https://miro.medium.com/v2/resize:fit:1302/format:webp/1*toNMPcU7LVmJYFFo2160Cw.png data-desc-position=bottom><img src=https://miro.medium.com/v2/resize:fit:1302/format:webp/1*toNMPcU7LVmJYFFo2160Cw.png title alt data-align=center></a></p> <h3 id=pros_1>Pros<a class=headerlink href=#pros_1 title="Permanent link">¶</a></h3> <ul> <li>We were able to achieve horizontal scalability, every event was processed in a separate process/worker and had no impact on other events in-case of failure</li> <li>With BULL, there was built-in retry logic with an exponential backoff which helps to prevent sporadic errors like network issues</li> <li>Pushed based PUB/SUB design with delayed events were processed with reasonable timing precision</li> <li>For monitoring jobs, we were able to use an <a href=https://github.com/bee-queue/arena#readme target=_blank>open-source UI</a> which helped us a lot to track job states</li> </ul> <h3 id=cons_1>Cons<a class=headerlink href=#cons_1 title="Permanent link">¶</a></h3> <ul> <li>Redis is not backed by disk. It works really well for the immediate jobs where you need high throughput, to keep jobs that have to run in the future consumes lots of memory and it is costly</li> <li>The way we were using Redis for long-scheduled tasks was not ideal. We used to submit all the events in Redis at the time of Campaign creation and individual job state mutations were not being tracked in the SQL database in an immutable or append-only manner. Since every historical state mutation at any point in time was not being tracked in a centralized place it was really hard for us to re-try or audit all the events processed or failed. At one point our EC2 server EBS volumes ran out of disk space due to an issue where log files were not being truncated. All the Redis jobs started failing because they couldn’t write the log statements to disk and exhausted all the re-try attempts even with exponential backoff. Since not all the events were tracked it was really hard for us to re-try a particular event after fixing the issue</li> <li>As the backend at Vincere was maturing we started creating multiple micro-services. Most of them had to interact with a job queue for delayed or immediate processing. We were very tightly coupled with Redis and Bull. There wasn’t one documented interface to enqueue jobs. All the developers had to get familiar with Bull API. And if we were to change our queue e.g, move to SQS or Kafka in the future it would be impossible to change application code due to tight coupling</li> </ul> <h2 id=third-iteration-of-background-jobs>Third Iteration of Background Jobs<a class=headerlink href=#third-iteration-of-background-jobs title="Permanent link">¶</a></h2> <p>After a couple of iterations, we decided to write our own Job Queue utilizing PostgresSQL. We called it <a href=https://github.com/vincere-health/programma target=_blank>Programma</a>. You might be wondering why "reinvent the wheel". Following were the main reasons we took this path</p> <ul> <li>Our use-case was to track these jobs in one place for simplicity, like SQL/NoSQL store without too much effort in a simple schema model. We attempt to track job states in Postgres through a simple interface. We choose Postgres due to its <a href="https://www.2ndquadrant.com/en/blog/what-is-select-skip-locked-for-in-postgresql-9-5/#:~:text=PostgreSQL%209.5%20introduces%20a%20new,and%20efficient%20concurrent%20work%20queues" target=_blank>SKIP LOCK</a> feature that is very suitable for building a queue backed by Postgres</li> <li>The goal of Programma is to expose a very flexible and simple API. Where client could nudge the job processing lifecycle by calling utility methods without us dictating the specific lifecycle of a job</li> <li>Programma ensures a job is delivered and claimed by the processor with retryAfterSeconds logic until job status is changed. This parameter is customizable and you can use it for exponential backoff logic as well by changing the retryAfterSeconds. Received messages that are not changed to either Processing, Completed, or FAILED state will appear again after retryAfterSecond timeout</li> <li>Programma exposes Promise-based API and written in typescript which helps us a lot since most of our stack is in NodeJS and Typescript helps us to create self-documenting job interfaces</li> </ul> <p>The third iteration and current iteration works like this</p> <p><a class=glightbox data-type=image data-width=auto data-height=auto href=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iLRbuc1vd4KAFXASiTWB8Q.png data-desc-position=bottom><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iLRbuc1vd4KAFXASiTWB8Q.png title alt data-align=center></a></p> <ol> <li>At the time of Campaign creation, we enqueue all the jobs using Programma API and add high-level campaign metadata in our application database</li> <li>Programma creates entries of jobs in the event-store(Postgres)</li> <li>Programma processor keeps polling database at a certain interval to see if there are any jobs that ready to be processed. We run multiple job poolers on different servers/containers for workload distribution. We can customize the pooling interval and max jobs per interval. This is where the Postgres <a href="https://www.2ndquadrant.com/en/blog/what-is-select-skip-locked-for-in-postgresql-9-5/#:~:text=PostgreSQL%209.5%20introduces%20a%20new,and%20efficient%20concurrent%20work%20queues." target=_blank>SKIP LOCK</a> feature comes really handy to skip the rows that are already claimed and avoid double processing</li> <li>Once a job is ready to be processed we change the job status to processing. Programma does not implement any job worker logic. That's why we fan-out all the ready jobs to Redis Queue with Bull for processing</li> <li>Once a job is processed by the <a href=https://github.com/OptimalBits/bull#separate-processes target=_blank>Bull Worker</a> we update the job status in the event-store using Programma API. Re-try logic is handled by the Bull queue manager</li> </ol> <p>Our application code and different microservices enqueue the jobs using the following API</p> <div class="language-ts highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kd>interface</span><span class=w> </span><span class=nx>IJobConfig</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>  </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>  </span><span class=nx>attributes</span><span class=o>?:</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>  </span><span class=nx>runAfterSeconds?</span><span class=o>:</span><span class=w> </span><span class=kt>number</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>  </span><span class=nx>runAfterDate?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nb>Date</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>  </span><span class=nx>retryAfterSeconds?</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=p>}</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=kd>interface</span><span class=w> </span><span class=nx>IProgramma</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>  </span><span class=nx>addJob</span><span class=p>(</span><span class=nx>topicName</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>job</span><span class=o>:</span><span class=w> </span><span class=kt>IJobConfig</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>string</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=p>}</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=kd>const</span><span class=w> </span><span class=nx>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>programma</span><span class=p>.</span><span class=nx>addJob</span><span class=p>(</span><span class=s1>'sendEmail'</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>  </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>'test@xyz.com'</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=w>  </span><span class=nx>runAfterDate</span><span class=o>:</span><span class=w> </span><span class=s1>'2021-11-30T06:41:26.536Z'</span><span class=p>,</span><span class=w> </span><span class=c1>// run job next year</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=p>})</span>
</span></code></pre></div> <p>Job Processing microservices keep pooling the jobs like in the following example</p> <div class="language-ts highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kd>interface</span><span class=w> </span><span class=nx>IProgramma</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=nx>receiveJobs</span><span class=p>(</span><span class=nx>config</span><span class=o>:</span><span class=w> </span><span class=kt>IReceiveMessageConfig</span><span class=p>,</span><span class=w> </span><span class=nx>handler</span><span class=o>:</span><span class=w> </span><span class=kt>IHandlerCallback</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=ow>void</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=p>}</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=nx>programma</span><span class=p>.</span><span class=nx>receiveJobs</span><span class=p>({</span><span class=w> </span><span class=nx>topicName</span><span class=o>:</span><span class=w> </span><span class=s1>'sendEmail'</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>job</span><span class=o>:</span><span class=w> </span><span class=kt>IReceiveJob</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>  </span><span class=c1>// use bull to fan-out the jobs to different</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>  </span><span class=c1>// reliable sandboxed workers with retry logic</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>bullRedisQueue</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>job.id</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>job.data</span><span class=p>,</span><span class=w> </span><span class=nx>attributes</span><span class=o>:</span><span class=w> </span><span class=kt>job.data</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>retries</span><span class=o>:</span><span class=w> </span><span class=kt>3</span><span class=p>,</span><span class=w> </span><span class=nx>backoff</span><span class=o>:</span><span class=w> </span><span class=kt>20000</span><span class=p>,</span><span class=w> </span><span class=nx>timeout</span><span class=o>:</span><span class=w> </span><span class=kt>15000</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>  </span><span class=p>)</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>  </span><span class=c1>// move job to processing, after submitting it. </span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>  </span><span class=c1>// the status will be changed to processing and Redis queue will handle it</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>  </span><span class=c1>// if a job is not moved to different state</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=w>  </span><span class=c1>// it will be retired after retryAfterSecond period</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>programma</span><span class=p>.</span><span class=nx>moveJobToProcessing</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=p>})</span>
</span></code></pre></div> <p>Each job will be processed by an individual <a href=https://github.com/OptimalBits/bull#separate-processes target=_blank>Bull Worker</a> which is a separate Node process. Once a job is processed successfully, we change job status and track in DB through Programma API</p> <div class="language-ts highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nx>bullEmailRedisQueue</span><span class=p>.</span><span class=nx>process</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>job</span><span class=p>,</span><span class=w> </span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=c1>// send email</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>programma</span><span class=p>.</span><span class=nx>moveJobToDone</span><span class=p>(</span><span class=nx>jod</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>()</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>()</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=p>}</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=c1>// job failed after all the back-off retries</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=c1>// we can track that in SQL through programma API</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=nx>bullRedisQueue</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>'failed'</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>bullRedisQueue</span><span class=p>.</span><span class=nx>getJob</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>programma</span><span class=p>.</span><span class=nx>moveJobToFailed</span><span class=p>(</span><span class=nx>jod</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>  </span><span class=c1>// also can track error in SQL</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>programma</span><span class=p>.</span><span class=nx>setAttributes</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=p>})</span>
</span></code></pre></div> <h3 id=pros_2>Pros<a class=headerlink href=#pros_2 title="Permanent link">¶</a></h3> <ul> <li>Code abstraction that’s easy for developers to work with and different micro-services use simple API to enqueue background jobs</li> <li>Delayed tasks that have to run in the future do not consume too much memory</li> <li>Everything is tracked in one centralized event-store which is reliable i.e, backed by the disk, and for throughput, we utilize Redis PUB/SUB to fan-out jobs to different processors</li> <li>We can achieve horizontal scalability by running job polling logic on different CPUs/containers. Thanks to Postgres SKIP LOCK which help us achieve this</li> </ul> <h3 id=cons_2>Cons<a class=headerlink href=#cons_2 title="Permanent link">¶</a></h3> <p>Some of these might not be cons. But we will discuss trade-offs and future scalability problems</p> <ul> <li>Since every job regardless if it has to run immediately or in the future is tracked in event-store it consumes lots of space and the index size grows too. We plan to solve this in the future by running a configurable job archival process</li> <li>One SQL Database won’t be able to handle all the load. We plan to create multiple Programma clusters and shard tasks by Organization Id or something more efficient and route them to different clusters. Since Programma handles Job Table schema creation on the fly if it does not exist, we can run multiple local Postgres databases per programma cluster and scale-out. We are very inspired by the Pinterest implementation of <a href=https://github.com/pinterest/pinlater target=_blank>pinlater</a> and how it can scale out with MySQL based queue implementation</li> <li>Pooling based design instead of PUB/SUB wastes some CPU resources where you are continuously pooling even when no jobs are available to be processed in a particular interval. This is one of the tradeoffs we have to make for simplicity and reliability</li> </ul> <h3 id=avoiding-duplicate-processing-of-jobs>Avoiding duplicate processing of Jobs<a class=headerlink href=#avoiding-duplicate-processing-of-jobs title="Permanent link">¶</a></h3> <p>As we process payment events, where our users get paid through different payment gateways. We cannot take risk of double processing the event. Even with Postgres SKIP LOCK and Bull it’s hard to run into a scenario where a job is processed twice, but the situation could <a href=https://redis.io/docs/latest/develop/use/patterns/distributed-locks/ target=_blank>arise when the queue is stalled</a>. For such jobs, we use distributed locks with Redis Redlock. You can read this topic here regarding the distributed lock implementation</p> <div class="language-ts highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=c1>// try to acquire lock</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>  </span><span class=nx>redlock</span><span class=p>.</span><span class=nx>lock</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=mf>5000</span><span class=p>)</span><span class=w> </span><span class=c1>// acquire lock for 5 seconds</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=c1>// process payment</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=c1>// failed to acquire job. try next time</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=p>}</span>
</span></code></pre></div> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">¶</a></h2> <ul> <li>Most of our background job workflows are evolving into a <a href=https://en.wikipedia.org/wiki/Directed_acyclic_graph target=_blank>DAG</a> (Directed Acyclic Graph). We plan to model the parent-child relationship of jobs in the future for maintainability and having better visibility over workflows</li> <li>Creating a better API for queue metrics and measuring queue depth. If a job is not processed in a specific interval maybe set up some alarms etc.</li> <li>Creating a better archival process for the processed job for event-store maintainability</li> </ul> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">¶</a></h2> <ul> <li><a href=https://github.com/OptimalBits/bull#important-notes target=_blank>Bull Queue Documentation</a></li> <li><a href=https://www.2ndquadrant.com/en/blog/what-is-select-skip-locked-for-in-postgresql-9-5/ target=_blank>Understanding SELECT ... SKIP LOCKED in PostgreSQL</a></li> <li><a href=https://redis.io/topics/distlock target=_blank>Redis Distributed Locks</a></li> <li><a href=https://www.quora.com/q/quoraengineering/Qmessage-Handling-Billions-of-Tasks-Per-Day target=_blank>Qmessage: Handling Billions of Tasks Per Day</a></li> <li><a href=https://github.com/pinterest/pinlater target=_blank>Pinterest's Pinlater</a></li> <li><a href=https://www.holistics.io/blog/how-we-built-a-multi-tenant-job-queue-system-with-postgresql-ruby/ target=_blank>Building a Multi-Tenant Job Queue System with PostgreSQL</a></li> </ul> <div class=subscribe-container> <h3>Subscribe</h3> <p>Honest takes on AI, startups, and digital health—delivered to your inbox.</p> <p>Your privacy is paramount. Expect content once or twice a month. Unsubscribe anytime if you don't like it.</p> <a href=https://newsletter.hadijaveed.me class="md-button md-button--primary" target=_blank>Get Email Updates</a> </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../../../2017/07/29/making-responsive-grid-with-flexbox-and-lessjs/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Making responsive grid with Flexbox and LessJS"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Making responsive grid with Flexbox and LessJS </div> </div> </a> <a href=../../../../2022/03/04/helping-people-quit-smoking-through-financial-rewards/ class="md-footer__link md-footer__link--next" aria-label="Next: Helping People Quit Smoking Through Financial Rewards"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Helping People Quit Smoking Through Financial Rewards </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> © 2024 <a href=https://www.linkedin.com/in/hadijaveed target=_blank rel=noopener>Hadi Javeed</a> </div> </div> <div class=md-social> <a href=https://github.com/hadijaveed target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"></path></svg> </a> <a href=https://twitter.com/hadijpk target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> <a href=https://www.linkedin.com/in/hadijaveed target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../../..", "features": ["toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.top", "navigation.instant", "navigation.instant.prefetch", "navigation.expand", "navigation.indexes", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.tabs", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../assets/javascripts/bundle.f55a23d4.min.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>